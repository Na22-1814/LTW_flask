{% extends 'admin/layout.html' %}

{% block title %}Quản lý sách - Admin - Aloha{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="m-0">Danh sách sách</h2>
    <div class="d-flex gap-2">
        <a href="#" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">
            <i class="bi bi-funnel"></i> Lọc
        </a>
        <a href="{{ url_for('admin.add_book') }}" class="btn btn-primary">
            <i class="bi bi-plus"></i> Thêm sách mới
        </a>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" class="form-check-input select-all">
                </th>
                <th>Tên sách <i class="bi bi-caret-down-fill text-muted small"></i></th>
                <th>Thể loại <i class="bi bi-caret-down-fill text-muted small"></i></th>
                <th>Tác giả</th>
                <th>Giá <i class="bi bi-caret-down-fill text-muted small"></i></th>
                <th>Ngày thêm</th>
                <th>Trạng thái <i class="bi bi-caret-down-fill text-muted small"></i></th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input book-select" data-id="{{ book.BookID }}">
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            {% if book.CoverImage %}
                                <img src="{{ book.CoverImage }}" alt="{{ book.Title }}" width="40" height="40" class="me-2 rounded">
                            {% else %}
                                <img src="{{ url_for('static', filename='img/book1.png') }}" alt="{{ book.Title }}" width="40" height="40" class="me-2 rounded">
                            {% endif %}
                            <span>{{ book.Title }}</span>
                        </div>
                    </td>
                    <td>{{ book.category.CategoryName }}</td>
                    <td>{{ book.Author or 'Không có thông tin' }}</td>
                    <td>{{ '{:,.0f}'.format(book.Price) }} VND</td>
                    <td>{{ book.AddedDate.strftime('%d/%m/%Y') }}</td>
                    <td>
                        {% if book.Status %}
                            <span class="status-badge active">Hoạt động</span>
                        {% else %}
                            <span class="status-badge draft">Ẩn</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('book.book_detail', book_id=book.BookID) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{{ url_for('admin.edit_book', book_id=book.BookID) }}" class="btn btn-sm btn-primary">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <!-- Delete button with confirmation -->
                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ book.BookID }}">
                                <i class="bi bi-trash"></i>
                            </button>
                            
                            <!-- Delete Confirmation Modal -->
                            <div class="modal fade" id="deleteModal{{ book.BookID }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ book.BookID }}" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="deleteModalLabel{{ book.BookID }}">Xác nhận xóa</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Bạn có chắc chắn muốn xóa sách <strong>{{ book.Title }}</strong>?</p>
                                            <p class="text-danger">Hành động này không thể hoàn tác.</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                            <form action="{{ url_for('admin.delete_book', book_id=book.BookID) }}" method="post">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-danger">Xóa</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <p class="mb-0">Chưa có sách nào. Hãy thêm sách mới!</p>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Bulk actions -->
{% if books %}
    <div class="bulk-actions mt-3 mb-4">
        <div class="d-flex align-items-center">
            <span class="me-2">Với mục đã chọn:</span>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Hành động
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" id="bulkActivate">Kích hoạt</a></li>
                    <li><a class="dropdown-item" href="#" id="bulkDeactivate">Ẩn</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" id="bulkDelete">Xóa</a></li>
                </ul>
            </div>
        </div>
    </div>
{% endif %}

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Lọc sách</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('admin.books') }}" method="get" id="filterForm">
                    <div class="mb-3">
                        <label for="category" class="form-label">Thể loại</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">Tất cả thể loại</option>
                            {% for category in categories %}
                                <option value="{{ category.CategoryID }}" {% if request.args.get('category')|int == category.CategoryID %}selected{% endif %}>
                                    {{ category.CategoryName }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Trạng thái</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">Tất cả trạng thái</option>
                            <option value="1" {% if request.args.get('status') == '1' %}selected{% endif %}>Hoạt động</option>
                            <option value="0" {% if request.args.get('status') == '0' %}selected{% endif %}>Ẩn</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="price_min" class="form-label">Giá tối thiểu</label>
                        <input type="number" class="form-control" id="price_min" name="price_min" value="{{ request.args.get('price_min', '') }}">
                    </div>
                    <div class="mb-3">
                        <label for="price_max" class="form-label">Giá tối đa</label>
                        <input type="number" class="form-control" id="price_max" name="price_max" value="{{ request.args.get('price_max', '') }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="applyFilter">Áp dụng</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkDeleteModalLabel">Xác nhận xóa hàng loạt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa <span id="selectedCount">0</span> sách đã chọn?</p>
                <p class="text-danger">Hành động này không thể hoàn tác.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <form action="{{ url_for('admin.bulk_delete_books') }}" method="post" id="bulkDeleteForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="book_ids" id="bulkDeleteIds">
                    <button type="submit" class="btn btn-danger">Xóa</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Apply filter
        document.getElementById('applyFilter').addEventListener('click', function() {
            document.getElementById('filterForm').submit();
        });
        
        // Select all checkboxes
        const selectAll = document.querySelector('.select-all');
        const bookSelects = document.querySelectorAll('.book-select');
        
        if (selectAll) {
            selectAll.addEventListener('change', function() {
                bookSelects.forEach(function(checkbox) {
                    checkbox.checked = selectAll.checked;
                });
            });
        }
        
        // Bulk delete action
        const bulkDeleteBtn = document.getElementById('bulkDelete');
        if (bulkDeleteBtn) {
            bulkDeleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const selectedBooks = Array.from(document.querySelectorAll('.book-select:checked')).map(function(checkbox) {
                    return checkbox.dataset.id;
                });
                
                if (selectedBooks.length === 0) {
                    alert('Vui lòng chọn ít nhất một sách để xóa.');
                    return;
                }
                
                document.getElementById('selectedCount').textContent = selectedBooks.length;
                document.getElementById('bulkDeleteIds').value = selectedBooks.join(',');
                
                const bulkDeleteModal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
                bulkDeleteModal.show();
            });
        }
        
        // Bulk activate/deactivate actions
        const bulkActivateBtn = document.getElementById('bulkActivate');
        const bulkDeactivateBtn = document.getElementById('bulkDeactivate');
        
        if (bulkActivateBtn) {
            bulkActivateBtn.addEventListener('click', function(e) {
                e.preventDefault();
                updateBulkStatus(true);
            });
        }
        
        if (bulkDeactivateBtn) {
            bulkDeactivateBtn.addEventListener('click', function(e) {
                e.preventDefault();
                updateBulkStatus(false);
            });
        }
        
        function updateBulkStatus(status) {
            const selectedBooks = Array.from(document.querySelectorAll('.book-select:checked')).map(function(checkbox) {
                return checkbox.dataset.id;
            });
            
            if (selectedBooks.length === 0) {
                alert('Vui lòng chọn ít nhất một sách để cập nhật trạng thái.');
                return;
            }
            
            // Create a form to submit the bulk update
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('admin.bulk_update_books') }}";
            
            // Add CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = "{{ csrf_token() }}";
            form.appendChild(csrfInput);
            
            // Add book IDs
            const idsInput = document.createElement('input');
            idsInput.type = 'hidden';
            idsInput.name = 'book_ids';
            idsInput.value = selectedBooks.join(',');
            form.appendChild(idsInput);
            
            // Add status
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            statusInput.value = status ? '1' : '0';
            form.appendChild(statusInput);
            
            document.body.appendChild(form);
            form.submit();
        }
    });
</script>
{% endblock %}